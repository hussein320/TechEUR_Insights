<!DOCTYPE html>
<html>
  <head>
    <title>Interactive Europe Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .tooltip {
        position: absolute;
        text-align: center;
        padding: 8px;
        font: 12px;
        background: rgb(254, 254, 255);
        border: 2px solid black;
        border-radius: 8px;
        pointer-events: none;
        opacity: 0;
        font-family: "Roboto";
      }

      .country-path {
        transition: fill 0.4s, stroke-width 0.2s, transform 0.2s;
      }

      .country-path:hover {
        cursor: pointer;
        stroke-width: 2;
        transform: scale(1.02);
        stroke: rgb(0, 0, 0);
      }

      .time-traveler {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 20%;
        max-width: 500px;
        min-width: 50px;
        max-height: 20px;
        padding: 10px;
        background-color: #d4e6f4;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .button {
        cursor: pointer;
        border: none;
        background-color: transparent;
        font-size: 14px;
        margin: 5px;
      }

      .year-display,
      .country-display {
        font-size: 18px;
        font-family: "Roboto", sans-serif;
        margin: 10px 0;
      }

      .map-container {
        position: relative;
        width: 100%; /* Full width */
        height: 100%; /* Full height, adjusted to prevent overflow */
        display: flex;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden; /* Prevent scrollbars */
        height: 100%; /* Full height */
      }

      svg {
        overflow: visible;
      }
    </style>
  </head>
  <body>
    <div class="map-container">
      <svg class="Testing"></svg>
      <div class="tooltip">Tooltip</div>
    </div>
    <div class="time-traveler">
      <button class="button" id="prevYear">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="year-display">Year: 2010</span>
      <button class="button" id="nextYear">
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>
    <script>
      let width = window.innerWidth * 0.78,
        height = window.innerHeight * 0.4;
      let currentYear = 2010;
      let dataByCountryYear = [
        {
          country: "Belgium",
          years: { 2010: "21.91", 2015: "17.56", 2019: 14.7 },
        },
        {
          country: "Bulgaria",
          years: { 2010: "13.28", 2015: "11.17", 2019: 2.86 },
        },
        {
          country: "Czechia",
          years: { 2010: "2.81", 2015: "4.27", 2019: 11.38 },
        },
        {
          country: "Denmark",
          years: { 2010: "18.86", 2015: "21.46", 2019: 15.2 },
        },
        {
          country: "Germany",
          years: { 2010: "9.17", 2015: "9.31", 2019: 13.38 },
        },
        {
          country: "Estonia",
          years: { 2010: "8.98", 2015: "15.80", 2019: 18.72 },
        },
        {
          country: "Ireland",
          years: { 2010: "9.30", 2015: "10.93", 2019: 15.6 },
        },
        {
          country: "Greece",
          years: { 2010: "10.37", 2015: "10.48", 2019: 9.3 },
        },
        {
          country: "Spain",
          years: { 2010: "26.29", 2015: "22.01", 2019: 23.77 },
        },
        {
          country: "France",
          years: { 2010: "23.45", 2015: "25.54", 2019: 30.06 },
        },
        {
          country: "Croatia",
          years: { 2010: "7.41", 2015: "10.08", 2019: 6.36 },
        },
        {
          country: "Italy",
          years: { 2010: "23.73", 2015: "16.84", 2019: 10.72 },
        },
        {
          country: "Cyprus",
          years: { 2010: "9.30", 2015: "6.84", 2019: 17.21 },
        },
        {
          country: "Latvia",
          years: { 2010: "14.82", 2015: "22.16", 2019: 8.68 },
        },
        {
          country: "Lithuania",
          years: { 2010: "5.43", 2015: "4.58", 2019: 5.81 },
        },
        {
          country: "Luxembourg",
          years: { 2010: "20.98", 2015: "15.60", 2019: 7.51 },
        },
        {
          country: "Hungary",
          years: { 2010: "7.67", 2015: "8.69", 2019: 8.04 },
        },
        {
          country: "Malta",
          years: { 2010: "7.20", 2015: "19.23", 2019: 19.08 },
        },
        {
          country: "Netherlands",
          years: { 2010: "15.16", 2015: "19.34", 2019: 20.55 },
        },
        {
          country: "Austria",
          years: { 2010: "12.44", 2015: "15.72", 2019: 19.69 },
        },
        { country: "Poland", years: { 2010: "6.85", 2015: "4.69", 2019: 7.1 } },
        {
          country: "Portugal",
          years: { 2010: "12.71", 2015: "20.70", 2019: 19.78 },
        },
        {
          country: "Romania",
          years: { 2010: "3.49", 2015: "21.88", 2019: 8.99 },
        },
        {
          country: "Slovenia",
          years: { 2010: "13.44", 2015: "17.90", 2019: 21.25 },
        },
        {
          country: "Slovakia",
          years: { 2010: "5.46", 2015: "7.36", 2019: 13.48 },
        },
        {
          country: "Finland",
          years: { 2010: "23.54", 2015: "24.45", 2019: 24.74 },
        },
        {
          country: "Sweden",
          years: { 2010: "22.81", 2015: "31.22", 2019: 25.06 },
        },
        { country: "Iceland", years: { 2010: "20.63", 2015: ":", 2019: 24.9 } },
        {
          country: "Norway",
          years: { 2010: "24.59", 2015: "26.48", 2019: 18.72 },
        },
        {
          country: "United Kingdom",
          years: { 2010: "13.88", 2015: "10.61", 2019: 12.5 },
        },
        {
          country: "Bosnia and Herzegovina",
          years: { 2010: ":", 2015: ":", 2019: 3.44 },
        },
        { country: "Montenegro", years: { 2010: ":", 2015: ":", 2019: 1.18 } },
        {
          country: "North Macedonia",
          years: { 2010: "15.34", 2015: "27.84", 2019: 18.59 },
        },
        { country: "Albania", years: { 2010: ":", 2015: ":", 2019: 3.69 } },
        { country: "Serbia", years: { 2010: ":", 2015: "11.41", 2019: 13.71 } },
        {
          country: "TÃ¼rkiye",
          years: { 2010: "5.18", 2015: "6.16", 2019: 10.44 },
        },
        { country: "Kosovo", years: { 2010: ":", 2015: ":", 2019: 9.68 } },
      ];

      let allValues = dataByCountryYear.flatMap((d) => Object.values(d.years));

      // Filter out non-numeric values and convert to numbers
      allValues = allValues.filter((v) => !isNaN(v)).map(Number);

      // Calculate the max value from the array of all values
      let maxValue = d3.max(allValues);

      // Create the color scale with the dynamic domain using the max value
      let colorScale = d3
        .scaleSequential()
        .interpolator(d3.interpolateBlues)
        .domain([0, maxValue]);
      var margin = { top: 50, right: 180, bottom: 50, left: 160 };
      let svg = d3
        .select("svg")
        .attr("width", "100px")
        .attr("height", height)
        .style("position", "absolute")
        .style("top", "110px")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
      let tooltip = d3.select(".tooltip");

      let europeProjection = d3
        .geoMercator()
        .center([13, 52])
        .scale(width / 2.1)
        .translate([width / 2, height / 2 + 30]);

      let pathGenerator = d3.geoPath().projection(europeProjection);

      let transformedDataByCountryYear = dataByCountryYear.reduce(
        (acc, { country, years }) => {
          acc[country] = years;
          return acc;
        },
        {}
      );
      function resize() {
        width = window.innerWidth * 0.6;
        height = window.innerHeight * 0.4;

        svg.attr("width", width).attr("height", height);

        europeProjection
          .scale(width / 2.1)
          .translate([width / 2, height / 2 + 30]);

        updateVisualization();
      }

      // Listen for the window resize event
      window.addEventListener("resize", resize);

      function updateVisualization() {
        d3.json(
          "https://gist.githubusercontent.com/spiker830/3eab0cb407031bf9f2286f98b9d0558a/raw/7edae936285e77be675366550e20f9166bed0ed5/europe_features.json"
        ).then((geojson) => {
          let countries = svg.selectAll(".country-path").data(geojson.features);

          countries
            .enter()
            .append("path")
            .attr("class", "country-path")
            .merge(countries)
            .attr("d", pathGenerator)
            .attr("fill", (d) => {
              let countryName = d.properties.name;
              let countryData = transformedDataByCountryYear[countryName]
                ? transformedDataByCountryYear[countryName][
                    currentYear.toString()
                  ]
                : undefined;

              return countryData === ":"
                ? "gray"
                : countryData
                ? colorScale(countryData)
                : "gray";
            })
            .on("mouseover", function (event, d) {
              svg.selectAll(".country-path").style("opacity", 0.4);

              d3.select(this)
                .style("opacity", 1)
                .style("transform-origin", "center");

              let countryName = d.properties.name;
              let year = currentYear;
              let countryData;
              if (
                transformedDataByCountryYear[countryName] &&
                transformedDataByCountryYear[countryName][
                  currentYear.toString()
                ]
              ) {
                countryData =
                  transformedDataByCountryYear[countryName][
                    currentYear.toString()
                  ] === ":"
                    ? "Data not available"
                    : transformedDataByCountryYear[countryName][
                        currentYear.toString()
                      ];
              } else {
                countryData = "Data not available";
              }

              tooltip
                .html(
                  `Country: ${countryName}<br/>Year: ${year}<br/>Percentage: ${countryData}`
                )
                .style("left", event.pageX + 40 + "px")
                .style("top", event.pageY - 38 + "px")
                .transition()
                .duration(200)
                .style("opacity", 1);
            })
            .on("mouseout", function () {
              svg.selectAll(".country-path").style("opacity", 1);

              d3.select(this).style("transform", "scale(1)");

              tooltip.transition().duration(500).style("opacity", 0);
            });
          const legendMargin = { top: 50, right: 20, bottom: 50, left: 20 };
          const legendWidth = window.innerWidth * 0.02;
          const legendHeight = window.innerHeight * 0.4;
          const numOfGradientStops = 10; // Number of stops in the gradient

          // Remove previous legend if it exists
          svg.select(".legend").remove();

          // Create a group for the legend
          const legend = svg
            .append("g")
            .attr("class", "legend")
            .attr(
              "transform",
              `translate(${width - legendMargin.right - legendWidth},${
                legendMargin.top - 60
              })`
            );

          // Create a linear gradient identifier
          const linearGradientId = "linear-gradient";

          // Define the gradient
          const gradient = legend
            .append("defs")
            .append("linearGradient")
            .attr("id", linearGradientId)
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", "0%")
            .attr("y1", "100%")
            .attr("x2", "0%")
            .attr("y2", "0%");

          // Create color stops for the gradient
          d3.range(numOfGradientStops).forEach((i) => {
            gradient
              .append("stop")
              .attr("offset", `${(i / (numOfGradientStops - 1)) * 100}%`)
              .attr(
                "stop-color",
                colorScale(
                  (i / (numOfGradientStops - 1)) * colorScale.domain()[1]
                )
              );
          });

          // Draw the legend bar
          legend
            .append("rect")
            .attr("width", legendWidth)
            .attr("height", legendHeight)
            .style("fill", `url(#${linearGradientId})`);

          // Define the scale for the legend axis
          const legendScale = d3
            .scaleLinear()
            .range([legendHeight, 0])
            .domain([0, maxValue]);

          // Define the legend axis
          const legendAxis = d3
            .axisRight(legendScale)
            .ticks(5)
            .tickFormat((d) => d.toFixed(1));

          // Draw the legend axis
          legend
            .append("g")
            .attr("class", "legend-axis")
            .attr("transform", `translate(${legendWidth}, 0)`)
            .call(legendAxis);
          countries
            .exit()
            .remove()
            .selectAll("text")
            .style("font-family", "Roboto");
        });
      }
      document
        .getElementById("prevYear")
        .addEventListener("click", function () {
          if (currentYear === 2019) {
            currentYear = 2015;
          } else if (currentYear === 2015) {
            currentYear = 2010;
          }
          document.querySelector(".year-display").innerText =
            "Year: " + currentYear;
          updateVisualization();
        });

      document
        .getElementById("nextYear")
        .addEventListener("click", function () {
          if (currentYear === 2010) {
            currentYear = 2015;
          } else if (currentYear === 2015) {
            currentYear = 2019;
          }
          document.querySelector(".year-display").innerText =
            "Year: " + currentYear;
          updateVisualization();
        });

      updateVisualization(); // Initial call to display map
    </script>
  </body>
</html>
